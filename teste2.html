<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Página pai - Detalhes do pedido</title>
<style>
  body{font-family:Inter,Arial,Helvetica,sans-serif;margin:32px;background:#f5f6fa;color:#111}
  .btn{padding:8px 12px;border-radius:8px;background:#0b5fff;color:#fff;border:none;cursor:pointer}
  /* overlay que cobre a tela e contém o iframe */
  .iframe-overlay{
    position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:9999;
  }
  .iframe-box{width:760px;max-width:calc(100% - 40px);height:auto;border-radius:12px;overflow:hidden;background:#fff;border:1px solid rgba(0,0,0,0.06)}
  .iframe-box iframe{width:100%;height:640px;border:0;display:block;background:transparent}
  .info{margin-bottom:12px}
  pre{background:#fff;padding:12px;border-radius:8px;border:1px solid #e6e9ef}
</style>
</head>
<body>

  <h1>Detalhes do pedido #1234 (exemplo)</h1>
  <div class="info">Aqui você tem sua tela de detalhes. Clique em editar para abrir o modal (iframe).</div>
  <button id="openEditor" class="btn">Editar pedido</button>

  <h3 style="margin-top:20px">Última ação recebida do editor (para debug)</h3>
  <pre id="log">nenhuma ação</pre>

  <!-- Overlay com iframe -->
  <div id="overlay" class="iframe-overlay" role="dialog" aria-modal="true">
    <div class="iframe-box">
      <iframe id="editorIframe" src="editor-iframe.html" title="Editor de pedido"></iframe>
    </div>
  </div>

<script>
  const overlay = document.getElementById('overlay');
  const iframe = document.getElementById('editorIframe');
  const openBtn = document.getElementById('openEditor');
  const log = document.getElementById('log');

  // Exemplo do objeto pedido que a página já tem
  const currentOrder = {
    id: 1234,
    status: 'Pago',
    paymentMethod: 'Cartão',
    delivery: {
      name: 'João da Silva',
      phone: '(11) 9 9999-9999',
      street: 'Av. Exemplo, 123',
      city: 'São Paulo - SP',
      zip: '01234-567'
    },
    adminNote: 'Cliente pediu entrega manha'
  };

  // abre o overlay + envia dados para o iframe
  openBtn.addEventListener('click', () => {
    overlay.style.display = 'flex';
    // depois que o iframe carregar, mandamos os dados
    iframe.contentWindow.postMessage({ type: 'editor:load', payload: currentOrder }, '*');
  });

  // recebe mensagens do iframe
  window.addEventListener('message', ev => {
    const msg = ev.data;
    if(!msg || !msg.type) return;

    // debug log
    log.textContent = JSON.stringify(msg, null, 2);

    switch(msg.type){
      case 'editor:ready':
        // opcional: iframe pronto
        console.log('iframe ready');
        break;

      case 'editor:cancel':
        // fecha overlay sem salvar
        overlay.style.display = 'none';
        break;

      case 'editor:apply':
        // aplicar alterações localmente (preview)
        // msg.payload contem os campos editados
        console.log('apply', msg.payload);
        // atualize o DOM local se quiser mostrar preview sem salvar
        break;

      case 'editor:save':
        // aqui você faria a requisição para o backend (fetch/axios)
        console.log('save payload', msg.payload);
        // Exemplo: chama sua API
        // fetch('/api/pedido/1234', { method:'PUT', body: JSON.stringify(msg.payload) })
        //   .then(()=> { overlay.style.display='none'; refreshPageOrUI(); });

        // Para demo: fecha o modal e atualiza currentOrder
        Object.assign(currentOrder, {
          status: msg.payload.status,
          paymentMethod: msg.payload.payment,
          delivery: {
            name: msg.payload.receiver,
            phone: msg.payload.phone,
            street: msg.payload.street,
            city: msg.payload.city,
            zip: msg.payload.zip
          },
          adminNote: msg.payload.note
        });
        overlay.style.display = 'none';
        alert('Simulação: pedido salvo. Aqui você chamaria seu backend.');
        break;
    }
  });

  // fecha ao clicar fora (opcional)
  overlay.addEventListener('click', e => {
    if(e.target === overlay) overlay.style.display = 'none';
  });
</script>

</body>
</html>
